<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Copy Tool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#121212">
  <link rel="manifest" href="manifest.json">

  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      margin: 0;
      padding: 40px;
      text-align: center;
      color: #f0f0f0;
      background: url("anh.png") no-repeat center center fixed;
      background-size: cover;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      max-width: 600px;
      margin: 20px auto;
      background: rgba(30,30,30,0.65);
      backdrop-filter: blur(18px) saturate(150%);
      -webkit-backdrop-filter: blur(18px) saturate(150%);
      border: 1px solid rgba(255,255,255,0.1);
      color: #f0f0f0;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 25px rgba(0,0,0,0.4);
    }

    td {
      padding: 12px 15px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      cursor: pointer;
      text-align: left;
      font-size: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    td:hover {
      background: rgba(255,255,255,0.12);
    }

    .copied {
      color: #00ff99;
      font-size: 13px;
      display: none;
    }

    /* Menu chuột phải mica */
    #contextMenu {
      position: absolute;
      display: none;
      background: rgba(30,30,30,0.75);
      backdrop-filter: blur(12px) saturate(180%);
      -webkit-backdrop-filter: blur(12px) saturate(180%);
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 2px 2px 10px rgba(0,0,0,0.5);
      z-index: 1000;
      font-size: 14px;
      color: #f0f0f0;
      border-radius: 8px;
      min-width: 140px;
    }

    #contextMenu div {
      padding: 10px 14px;
      cursor: pointer;
    }

    #contextMenu div:hover {
      background: rgba(255,255,255,0.15);
    }

    /* Popup mica */
    .popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(30,30,30,0.8);
      backdrop-filter: blur(18px) saturate(180%);
      -webkit-backdrop-filter: blur(18px) saturate(180%);
      border: 1px solid rgba(255,255,255,0.2);
      padding: 20px;
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
      z-index: 2000;
      display: none;
      box-shadow: 0 4px 20px rgba(0,0,0,0.6);
    }

    .popup textarea {
      width: 100%;
      padding: 12px;
      font-size: 15px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.1);
      color: #fff;
      resize: none;
      font-family: "Segoe UI", sans-serif;
      box-sizing: border-box;
    }

    /* Responsive */
    @media (max-width: 600px) {
      body { padding: 15px; }
      td { font-size: 14px; padding: 10px 12px; }
      .popup textarea { font-size: 14px; }
      #contextMenu { font-size: 13px; min-width: 110px; }
    }
  </style>
</head>
<body>
  <table id="copyTable">
    <tr draggable="true"><td onclick="copyText(this,'duy1nuis')">duy1nuis <span class="copied">Copied</span></td></tr>
    <tr draggable="true"><td onclick="copyText(this,'duy7nuis')">duy7nuis <span class="copied">Copied</span></td></tr>
    <tr draggable="true"><td onclick="copyText(this,'Duy@10102006')">Duy@10102006 <span class="copied">Copied</span></td></tr>
  </table>

  <div id="contextMenu">
    <div id="addItem">Thêm</div>
    <div id="editItem">Sửa</div>
    <div id="deleteItem">Xoá</div>
  </div>

  <!-- Popup mica -->
  <div id="popup" class="popup">
    <textarea id="popupInput" rows="3" placeholder="Nhập nội dung..."></textarea>
  </div>

  <script>
    let currentCell = null;
    let dragSrcRow = null;
    let popupMode = null; // "add" | "edit"

    function copyText(cell, text) {
      navigator.clipboard.writeText(text).then(() => {
        const copied = cell.querySelector(".copied");
        if (copied) {
          copied.style.display = "inline";
          setTimeout(() => copied.style.display = "none", 1000);
        }
      });
    }

    function createRow(value, save = true) {
      const table = document.getElementById("copyTable");
      const row = table.insertRow(table.rows.length);
      row.setAttribute("draggable", "true");
      const cell = row.insertCell(0);
      cell.innerHTML = `${value} <span class="copied">Copied</span>`;
      cell.onclick = () => copyText(cell, value);

      setupCellEvents(cell);
      addDragDropEvents(row);

      if (save) {
        let saved = JSON.parse(localStorage.getItem("customItems") || "[]");
        saved.push(value);
        localStorage.setItem("customItems", JSON.stringify(saved));
      }
    }

    // Setup sự kiện chuột phải + nhấn giữ
    function setupCellEvents(cell) {
      // Chuột phải (PC)
      cell.oncontextmenu = (e) => {
        e.preventDefault();
        currentCell = cell;
        showContextMenu(e.pageX, e.pageY);
      };

      // Nhấn giữ (Mobile)
      let pressTimer;
      cell.ontouchstart = (e) => {
        pressTimer = setTimeout(() => {
          currentCell = cell;
          showContextMenu(e.touches[0].pageX, e.touches[0].pageY);
        }, 500); // giữ 0.5s
      };
      cell.ontouchend = () => clearTimeout(pressTimer);
    }

    // Load dữ liệu
    window.onload = () => {
      let saved = JSON.parse(localStorage.getItem("customItems") || "[]");
      saved.forEach(item => createRow(item, false));

      document.querySelectorAll("#copyTable tr[draggable]").forEach(row => {
        setupCellEvents(row.cells[0]);
        addDragDropEvents(row);
      });
    };

    // Context menu
    const menu = document.getElementById("contextMenu");
    function showContextMenu(x, y) {
      menu.style.left = x + "px";
      menu.style.top = y + "px";
      menu.style.display = "block";
    }
    window.onclick = () => menu.style.display = "none";

    // Popup
    const popup = document.getElementById("popup");
    const popupInput = document.getElementById("popupInput");

    function openPopup(mode, defaultText = "") {
      popupMode = mode;
      popupInput.value = defaultText;
      popup.style.display = "block";
      popupInput.focus();
    }

    function closePopup() {
      popup.style.display = "none";
    }

    function confirmPopup() {
      const value = popupInput.value.trim();
      if (!value) { closePopup(); return; }

      if (popupMode === "add") {
        createRow(value);
      } else if (popupMode === "edit" && currentCell) {
        currentCell.innerHTML = `${value} <span class="copied">Copied</span>`;
        currentCell.onclick = () => copyText(currentCell, value);
        setupCellEvents(currentCell);
        updateLocalStorage();
      }
      closePopup();
    }

    // Menu chức năng
    document.getElementById("addItem").onclick = () => openPopup("add", "");
    document.getElementById("editItem").onclick = () => {
      if (currentCell) {
        let oldText = currentCell.textContent.replace("Copied", "").trim();
        openPopup("edit", oldText);
      }
    };
    document.getElementById("deleteItem").onclick = () => {
      if (currentCell) {
        currentCell.parentElement.remove();
        updateLocalStorage();
      }
    };

    // Sự kiện bàn phím trong popup
    popupInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        confirmPopup();
      } else if (e.key === "Escape") {
        e.preventDefault();
        closePopup();
      }
    });

    // Drag & Drop
    function addDragDropEvents(row) {
      row.addEventListener("dragstart", () => {
        dragSrcRow = row;
        row.classList.add("dragging");
      });
      row.addEventListener("dragend", () => {
        row.classList.remove("dragging");
        document.querySelectorAll("#copyTable tr").forEach(r => r.classList.remove("drag-over"));
        updateLocalStorage();
      });
      row.addEventListener("dragover", (e) => {
        e.preventDefault();
        if (row !== dragSrcRow) row.classList.add("drag-over");
      });
      row.addEventListener("dragleave", () => row.classList.remove("drag-over"));
      row.addEventListener("drop", () => {
        if (row !== dragSrcRow) {
          row.classList.remove("drag-over");
          row.parentNode.insertBefore(dragSrcRow, row);
        }
      });
    }

    // Update localStorage
    function updateLocalStorage() {
      let values = [];
      document.querySelectorAll("#copyTable tr").forEach(row => {
        let text = row.cells[0].textContent.replace("Copied", "").trim();
        if (!["duy1nuis","duy7nuis","Duy@10102006"].includes(text)) {
          values.push(text);
        }
      });
      localStorage.setItem("customItems", JSON.stringify(values));
    }

    // Service Worker
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./sw.js")
          .then(reg => console.log("Service Worker registered:", reg))
          .catch(err => console.log("SW registration failed:", err));
      });
    }
  </script>
</body>
</html>
