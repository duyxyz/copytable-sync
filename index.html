<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Copy Tool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#121212">

  <!-- Manifest -->
  <link rel="manifest" href="manifest.json">

  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #121212;
      margin: 0;
      padding: 40px;
      text-align: center;
      color: #f0f0f0;
    }
    table {
      border-collapse: collapse;
      width: 400px;
      margin: 20px auto;
      background: #1e1e1e;
      border: 1px solid #333;
      color: #f0f0f0;
    }
    td {
      padding: 12px 15px;
      border-bottom: 1px solid #333;
      cursor: pointer;
      text-align: left;
    }
    td:hover { background: #2a2a2a; }

    .copied {
      color: #00ff99;
      font-size: 13px;
      margin-left: 10px;
      display: none;
    }

    /* Menu chuột phải */
    #contextMenu {
      position: absolute;
      display: none;
      background: #1e1e1e;
      border: 1px solid #333;
      box-shadow: 2px 2px 6px rgba(0,0,0,0.5);
      z-index: 1000;
      font-size: 14px;
      color: #f0f0f0;
    }
    #contextMenu div {
      padding: 8px 12px;
      cursor: pointer;
    }
    #contextMenu div:hover { background: #2a2a2a; }

    .inputRow textarea {
      width: 95%;
      padding: 6px;
      font-size: 14px;
      resize: none;
      font-family: "Segoe UI", sans-serif;
      background: #2a2a2a;
      color: #f0f0f0;
      border: 1px solid #444;
    }
    .addRow {
      color: #888;
      text-align: center;
      font-style: italic;
    }

    /* Drag and drop highlight */
    .dragging { opacity: 0.5; }
    .drag-over { border-top: 2px solid #00bfff; }
  </style>
</head>
<body>
  <h1></h1>
  <table id="copyTable">
    <!-- Dòng mặc định -->
    <tr draggable="true"><td onclick="copyText(this,'duy1nuis')">duy1nuis <span class="copied">Copied</span></td></tr>
    <tr draggable="true"><td onclick="copyText(this,'duy7nuis')">duy7nuis <span class="copied">Copied</span></td></tr>
    <tr draggable="true"><td onclick="copyText(this,'Duy@10102006')">Duy@10102006 <span class="copied">Copied</span></td></tr>
    <!-- Dòng thêm mới -->
    <tr id="addNewRow"><td class="addRow">Thêm nội dung mới...</td></tr>
  </table>

  <!-- Menu chuột phải -->
  <div id="contextMenu">
    <div id="editItem">Sửa</div>
    <div id="deleteItem">Xoá</div>
  </div>

  <script>
    let currentCell = null;
    let dragSrcRow = null;

    function copyText(cell, text) {
      navigator.clipboard.writeText(text).then(() => {
        const copied = cell.querySelector(".copied");
        if (copied) {
          copied.style.display = "inline";
          setTimeout(() => copied.style.display = "none", 1000);
        }
      });
    }

    function createRow(value, save = true) {
      const table = document.getElementById("copyTable");
      const row = table.insertRow(table.rows.length - 1);
      row.setAttribute("draggable", "true");
      const cell = row.insertCell(0);
      cell.innerHTML = `${value} <span class="copied">Copied</span>`;
      cell.onclick = () => copyText(cell, value);

      // Menu chuột phải
      cell.oncontextmenu = (e) => {
        e.preventDefault();
        currentCell = cell;
        showContextMenu(e.pageX, e.pageY);
      };

      addDragDropEvents(row);

      if (save) {
        let saved = JSON.parse(localStorage.getItem("customItems") || "[]");
        saved.push(value);
        localStorage.setItem("customItems", JSON.stringify(saved));
      }
    }

    // Khi nhấn vào dòng thêm mới
    document.getElementById("addNewRow").onclick = () => {
      const row = document.getElementById("addNewRow");
      row.innerHTML = `
        <td class="inputRow">
          <textarea id="newInput" rows="2" placeholder="Nhập nội dung..."></textarea>
        </td>`;
      const input = document.getElementById("newInput");
      input.focus();

      input.onkeydown = (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          const value = input.value.trim();
          if (value) {
            createRow(value);
            resetAddRow();
          }
        } else if (e.key === "Escape") {
          resetAddRow();
        }
      };
    };

    function resetAddRow() {
      document.getElementById("addNewRow").innerHTML = `<td class="addRow">Thêm nội dung mới...</td>`;
    }

    // Load dữ liệu từ localStorage
    window.onload = () => {
      let saved = JSON.parse(localStorage.getItem("customItems") || "[]");
      saved.forEach(item => createRow(item, false));

      document.querySelectorAll("#copyTable tr[draggable]").forEach(row => {
        row.cells[0].oncontextmenu = (e) => {
          e.preventDefault();
          currentCell = row.cells[0];
          showContextMenu(e.pageX, e.pageY);
        };
        addDragDropEvents(row);
      });
    };

    // Context menu
    const menu = document.getElementById("contextMenu");
    function showContextMenu(x, y) {
      menu.style.left = x + "px";
      menu.style.top = y + "px";
      menu.style.display = "block";
    }
    window.onclick = () => menu.style.display = "none";

    // Menu chức năng
    document.getElementById("editItem").onclick = () => {
      if (currentCell) {
        let oldText = currentCell.textContent.replace("Copied", "").trim();
        let newText = prompt("Nhập nội dung mới:", oldText);
        if (newText && newText.trim()) {
          currentCell.innerHTML = `${newText} <span class="copied">Copied</span>`;
          currentCell.onclick = () => copyText(currentCell, newText.trim());
          updateLocalStorage();
        }
      }
    };

    document.getElementById("deleteItem").onclick = () => {
      if (currentCell) {
        currentCell.parentElement.remove();
        updateLocalStorage();
      }
    };

    // Drag and Drop
    function addDragDropEvents(row) {
      row.addEventListener("dragstart", () => {
        dragSrcRow = row;
        row.classList.add("dragging");
      });
      row.addEventListener("dragend", () => {
        row.classList.remove("dragging");
        document.querySelectorAll("#copyTable tr").forEach(r => r.classList.remove("drag-over"));
        updateLocalStorage();
      });
      row.addEventListener("dragover", (e) => {
        e.preventDefault();
        if (row !== dragSrcRow && !row.querySelector(".addRow")) {
          row.classList.add("drag-over");
        }
      });
      row.addEventListener("dragleave", () => row.classList.remove("drag-over"));
      row.addEventListener("drop", () => {
        if (row !== dragSrcRow && !row.querySelector(".addRow")) {
          row.classList.remove("drag-over");
          row.parentNode.insertBefore(dragSrcRow, row);
        }
      });
    }

    // Cập nhật localStorage theo bảng hiện tại
    function updateLocalStorage() {
      let values = [];
      document.querySelectorAll("#copyTable tr").forEach(row => {
        if (!row.querySelector(".addRow")) {
          let text = row.cells[0].textContent.replace("Copied", "").trim();
          if (!["duy1nuis","duy7nuis","Duy@10102006"].includes(text)) {
            values.push(text);
          }
        }
      });
      localStorage.setItem("customItems", JSON.stringify(values));
    }

    // Đăng ký service worker
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./sw.js")
          .then(reg => console.log("Service Worker registered:", reg))
          .catch(err => console.log("SW registration failed:", err));
      });
    }
  </script>
</body>
</html>

